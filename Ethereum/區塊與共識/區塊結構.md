---
tags: [ethereum, block, consensus, execution-layer, consensus-layer]
aliases: [Block Structure, 區塊, Block]
---

# 區塊結構

## 概述

區塊是 Ethereum 上「一批交易打包確認」的最小單位。每 12 秒產生一個區塊，裡面記錄了這段期間內所有被選中的交易及其執行結果。理解區塊的結構，是理解交易如何從「被送出」到「被確認」的關鍵。

當你在錢包按下「發送」後，交易最終會被某位 validator 打包進一個區塊。這個區塊包含兩個部分：共識層（Consensus Layer）負責決定「誰有權出塊、區塊是否有效」，執行層（Execution Layer）負責實際跑交易、更新餘額。兩層分開運作，再透過 Engine API 溝通。

本文將說明為什麼 Ethereum 採用這種雙層架構、Beacon Block 與 Execution Payload 各包含哪些欄位，以及區塊從組裝到確認的完整流程。

## 核心原理

### 雙層架構

為什麼要拆成兩層？2022 年 The Merge 之前，區塊是單一結構。合併後 Ethereum 從 PoW 轉向 PoS，共識邏輯和交易執行的複雜度都大幅增加。拆分讓兩邊可以獨立升級和優化：

- **Beacon Block**：共識層容器，攜帶 slot 編號、proposer 身分、父區塊引用等共識資訊
- **Execution Payload**：嵌在 Beacon Block body 裡的執行層資料，包含實際的交易列表與執行結果

CL 客戶端（如 Prysm、Lighthouse）和 EL 客戶端（如 Geth、Nethermind）各自獨立運行，透過 Engine API 交換資料。

> 區塊結構的欄位與[[區塊 Header]]有密切對應關係。本文的 Execution Payload 表格涵蓋完整欄位，區塊 Header 則側重 RLP 編碼順序與歷史欄位的演變。兩篇互補閱讀效果最佳。

### Beacon Block 結構

| 欄位 | 類型 | 說明 |
|------|------|------|
| `slot` | `uint64` | 所屬 slot 編號 |
| `proposer_index` | `ValidatorIndex` | 提議者在 validator registry 的 index |
| `parent_root` | `Root` | 父區塊的 hash tree root |
| `state_root` | `Root` | 後狀態的 [[SSZ 編碼]] hash tree root |
| `body` | `BeaconBlockBody` | 區塊主體 |

### BeaconBlockBody 主要欄位

| 欄位 | 說明 |
|------|------|
| `randao_reveal` | Proposer 的 [[RANDAO]] 揭示值（BLS signature） |
| `eth1_data` | 對 EL deposit contract 的引用 |
| `graffiti` | 32 bytes 自由欄位 |
| `proposer_slashings` | [[Slashing]] 證據（proposer 類） |
| `attester_slashings` | [[Slashing]] 證據（attester 類） |
| `attestations` | [[Attestation]] 列表 |
| `deposits` | 新質押存款 |
| `voluntary_exits` | 自願退出請求 |
| `sync_committee_bits` | Sync committee 參與位元 |
| `sync_committee_signature` | Sync committee 聚合簽名 |
| `execution_payload` | 執行層負載 |

### Execution Payload 結構

Execution Payload 攜帶所有交易執行相關資料，欄位對應舊的[[區塊 Header]]加上交易列表：

| 欄位 | 類型 | 說明 |
|------|------|------|
| `parent_hash` | `Hash32` | 父執行區塊的 [[Keccak-256]] hash |
| `fee_recipient` | `Address` | 接收 priority fee 的地址 |
| `state_root` | `Root` | 執行後的 [[State Trie]] root |
| `receipts_root` | `Root` | [[Receipt Trie]] root |
| `logs_bloom` | `ByteVector[256]` | [[Bloom Filter]] |
| `prev_randao` | `Hash32` | 前一個 [[RANDAO]] 混合值 |
| `block_number` | `uint64` | 區塊高度 |
| `gas_limit` | `uint64` | Gas 上限 |
| `gas_used` | `uint64` | 已使用 Gas |
| `timestamp` | `uint64` | Unix timestamp |
| `extra_data` | `ByteList[32]` | 額外資料 |
| `base_fee_per_gas` | `uint256` | [[EIP-1559 費用市場]] base fee |
| `block_hash` | `Hash32` | 執行區塊的 hash |
| `transactions` | `List[Transaction]` | [[交易生命週期\|交易]]列表（[[RLP 編碼]]） |
| `withdrawals` | `List[Withdrawal]` | 提款列表（Shanghai 升級後） |

EIP-4844 後新增 `blob_gas_used` 和 `excess_blob_gas` 欄位，用於 [[EIP-4844 Proto-Danksharding]] 的 blob gas 計價。

### 區塊 Hash 計算

兩層各自計算 hash：

- **CL**：對 Beacon Block 做 [[SSZ 編碼]] 後取 `hash_tree_root`
- **EL**：對 [[區塊 Header]] 做 [[RLP 編碼]] 後取 [[Keccak-256]] hash

## 在 Ethereum 中的應用

區塊是狀態轉換的原子單位。每個 slot（12 秒）最多產生一個區塊：

1. [[Validators]] 被選為 proposer，組裝 Beacon Block
2. EL 客戶端透過 Engine API 提供 Execution Payload
3. Proposer 簽名並廣播
4. 其他 validator 進行 [[Attestation]]，投票確認區塊有效性
5. 經過 [[Casper FFG]] 達成 finality

區塊驗證流程：
- CL 驗證 proposer 簽名、attestation 有效性、[[RANDAO]] reveal
- EL 驗證交易執行、state root、receipt root

## 程式碼範例

```python
# Beacon Block 結構（簡化版，對應 SSZ container）
from dataclasses import dataclass
from typing import List

@dataclass(frozen=True)
class BeaconBlock:
    slot: int
    proposer_index: int
    parent_root: bytes  # 32 bytes
    state_root: bytes   # 32 bytes
    body: 'BeaconBlockBody'

@dataclass(frozen=True)
class ExecutionPayload:
    parent_hash: bytes
    fee_recipient: bytes  # 20 bytes
    state_root: bytes
    receipts_root: bytes
    logs_bloom: bytes     # 256 bytes
    prev_randao: bytes
    block_number: int
    gas_limit: int
    gas_used: int
    timestamp: int
    extra_data: bytes
    base_fee_per_gas: int
    block_hash: bytes
    transactions: List[bytes]
    withdrawals: List['Withdrawal']
```

```javascript
// 透過 Engine API 取得 execution payload（EL 客戶端視角）
const block = await provider.getBlock("latest");
console.log({
  number: block.number,
  hash: block.hash,
  parentHash: block.parentHash,
  stateRoot: block.stateRoot,
  transactionsRoot: block.transactionsRoot,
  receiptsRoot: block.receiptsRoot,
  gasUsed: block.gasUsed.toString(),
  gasLimit: block.gasLimit.toString(),
  baseFeePerGas: block.baseFeePerGas.toString(),
  timestamp: block.timestamp,
});
```

## 相關概念

- [[區塊 Header]] - Execution Payload 中的 header 欄位定義
- [[Beacon Chain]] - 管理區塊 slot 分配與 proposer 選擇
- [[Validators]] - 負責提議與驗證區塊
- [[Attestation]] - Validator 對區塊的投票機制
- [[SSZ 編碼]] - Consensus Layer 的序列化格式
- [[RLP 編碼]] - Execution Layer 的序列化格式
- [[State Trie]] - 執行後的全局狀態樹
- [[EIP-4844 Proto-Danksharding]] - 新增 blob 相關欄位
- [[交易生命週期]] - 交易從建構到被區塊收錄的完整流程
