---
tags: [ethereum, consensus, intro, distributed-systems]
aliases: [共識入門, Consensus Intro, 共識機制入門]
---

# 共識入門

## 概述

區塊鏈的核心問題不是「如何儲存資料」，而是「一群互不信任的電腦如何對同一份資料達成一致」。這就是共識問題。Ethereum 使用 Proof of Stake 共識，透過 Consensus Layer 和 Execution Layer 的雙層架構運作。

## 為什麼需要共識？

傳統資料庫只有一台伺服器，它說了算。區塊鏈是數萬台節點同時運作，沒有中央權威。如果兩個節點同時提出不同的交易順序，網路必須有一套規則來決定「誰的版本才算數」。

這個問題在分散式系統中稱為**拜占庭將軍問題**（Byzantine Generals Problem）：一群將軍要協調進攻，但其中可能有叛徒傳遞假消息。即使有叛徒存在，忠誠的將軍仍需達成一致行動。

區塊鏈的共識機制就是這套協調規則。它必須在以下條件下仍能運作：

- 部分節點離線或網路延遲
- 部分節點刻意作弊（發送矛盾訊息）
- 沒有可信的中央協調者

## PoW vs PoS

Ethereum 從 2022 年 9 月的 The Merge 起，從 Proof of Work 切換到 Proof of Stake。兩者的核心差異：

| 面向 | Proof of Work (PoW) | Proof of Stake (PoS) |
|------|---------------------|----------------------|
| **安全基礎** | 電費和硬體成本 | 質押的 ETH（作弊就賠錢） |
| **參與者** | 礦工（miner） | [[Validators\|驗證者]]（validator） |
| **出塊方式** | 解數學難題，最快者出塊 | 被隨機選為 proposer |
| **能源消耗** | 極高（等同一個小國） | 極低（降低 99.95%） |
| **攻擊成本** | 需 51% 算力 | 需 1/3 質押量（約 1000 萬 ETH） |
| **懲罰機制** | 無（浪費電費而已） | [[Slashing]]（銷毀質押金） |

PoS 的核心邏輯：你質押真金白銀參與共識，如果你作弊，系統會沒收你的質押金。這讓攻擊的經濟成本遠高於 PoW。

## 雙層架構：CL + EL

The Merge 後，Ethereum 節點分為兩個獨立但協同運作的層：

**Consensus Layer (CL)**：管理共識邏輯
- 運行 [[Beacon Chain]]
- 管理 [[Validators]] 的註冊、獎懲、進退場
- 處理 [[Attestation]]（投票）和 finality（最終性）
- 維護時間模型（[[共識入門|slot/epoch]]）

**Execution Layer (EL)**：處理交易執行
- 執行智能合約
- 管理帳戶餘額和狀態
- 處理交易排序和 gas 計算

兩層透過 **Engine API**（JSON-RPC 協議）溝通。每個 slot 中，CL 告訴 EL「現在該出塊了」，EL 回傳打包好的交易（execution payload），CL 再將其包進 Beacon Block 廣播給全網。

```
CL 節點（如 Prysm、Lighthouse）
   |
   | Engine API
   |
EL 節點（如 Geth、Nethermind）
```

這個設計讓兩層可以獨立升級。例如 Pectra 升級同時改動了 CL（EIP-7251）和 EL（EIP-7702），但兩邊的變更互不干擾。

## 學習路徑建議

理解共識機制的推薦閱讀順序：

1. **[[共識入門]]**（本文）-- 共識的基本概念
2. **[[Slot 與 Epoch]]** -- 時間模型：12 秒和 32 slot 的設計理由
3. **[[區塊結構]]** -- CL + EL 雙層區塊的實際格式
4. **[[PoS 與質押入門]]** -- 質押如何保障安全
5. **[[Validators]]** -- 驗證者的完整生命週期
6. **[[Beacon Chain]]** -- 共識引擎的運作細節

## 相關概念

- [[Beacon Chain]] - Consensus Layer 的核心
- [[Validators]] - 共識的參與者
- [[Casper FFG]] - 決定哪些區塊永不可逆
- [[LMD GHOST]] - 決定鏈的最新頭部
- [[Slashing]] - 作弊者的懲罰機制
- [[Ethash]] - Ethereum 已棄用的 PoW 演算法（歷史背景）
