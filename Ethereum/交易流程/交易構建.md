---
tags: [ethereum, transaction, construction, RLP]
aliases: [Transaction Construction, 交易組裝, 交易建構]
---

# 交易構建

## 概述

交易構建就是把「我要做什麼」翻譯成 Ethereum 網路能理解的格式。不論是轉 1 ETH 給朋友（簡單轉帳），還是在 Uniswap 上兌換代幣（合約呼叫），你都需要填好一組欄位——收件人、金額、手續費上限等——然後序列化成二進位資料，準備送去簽名。

以轉帳為例：你的錢包會自動查詢你的 nonce（已發送幾筆交易）、估算 gas 費用、填入收件人地址和金額，然後打包成一筆 Type 2（EIP-1559）交易。如果是合約呼叫，`data` 欄位還會包含函數選擇器和參數編碼。

本文涵蓋三種交易類型（Legacy / EIP-1559 / EIP-7702）的欄位結構、序列化方式（[[RLP 編碼]] 或 typed transaction envelope），以及常見的構建陷阱。

## 核心原理

### 交易欄位

#### Legacy Transaction（Type 0）

| 欄位 | 型別 | 說明 |
|------|------|------|
| nonce | uint64 | 發送者已發送的交易數量（[[Nonce]]） |
| gasPrice | uint256 | 每單位 gas 的價格（wei） |
| gasLimit | uint64 | 最大 gas 消耗量 |
| to | address (20B) | 接收者地址；`null` 表示合約部署 |
| value | uint256 | 轉帳金額（wei） |
| data | bytes | calldata（合約呼叫或 init code） |

#### EIP-1559 Transaction（Type 2）

在 Legacy 基礎上替換 gasPrice 為兩個欄位：

| 欄位 | 型別 | 說明 |
|------|------|------|
| chainId | uint256 | 鏈 ID（[[EIP-155 重放保護]]） |
| nonce | uint64 | 同上 |
| maxPriorityFeePerGas | uint256 | 給 validator 的小費上限 |
| maxFeePerGas | uint256 | 願意支付的最大 gas 單價 |
| gasLimit | uint64 | 同上 |
| to | address | 同上 |
| value | uint256 | 同上 |
| data | bytes | 同上 |
| accessList | list | EIP-2930 存取列表 |

實際支付的 gas price：

$$\text{effectiveGasPrice} = \min(\text{maxFeePerGas},\ \text{baseFee} + \text{maxPriorityFeePerGas})$$

其中 baseFee 由協議根據區塊使用率動態調整（[[EIP-1559 費用市場]]）。

### EIP-7702 Transaction（Type 4，Pectra 2025/5/7）

Type 4 交易在 Type 2 的基礎上新增 `authorization_list` 欄位：

| 欄位 | 型別 | 說明 |
|------|------|------|
| chainId | uint256 | 鏈 ID |
| nonce | uint64 | 同上 |
| maxPriorityFeePerGas | uint256 | 同 Type 2 |
| maxFeePerGas | uint256 | 同 Type 2 |
| gasLimit | uint64 | 同上 |
| to | address | 目標地址 |
| value | uint256 | 同上 |
| data | bytes | 同上 |
| accessList | list | 同 Type 2 |
| authorizationList | list | **EIP-7702 新增**：授權列表 |

每個 authorization entry 結構：

| 欄位 | 說明 |
|------|------|
| chainId | 授權生效的鏈 ID（0 = 所有鏈） |
| address | 委託目標合約地址 |
| nonce | 授權者當前 nonce |
| yParity, r, s | 授權者的 ECDSA 簽名 |

交易發送者和授權者可以是不同的 EOA，這是 gas 代付功能的基礎。

### 序列化

**Legacy（Type 0）**：直接 RLP 編碼

$$\text{encoded} = \text{RLP}([\text{nonce}, \text{gasPrice}, \text{gasLimit}, \text{to}, \text{value}, \text{data}])$$

簽名前（含 EIP-155 chain ID）：

$$\text{signable} = \text{RLP}([\text{nonce}, \text{gasPrice}, \text{gasLimit}, \text{to}, \text{value}, \text{data}, \text{chainId}, 0, 0])$$

**Typed Transaction（Type 1/2/3/4）**：

$$\text{encoded} = \text{txType} \| \text{RLP}(\text{fields})$$

`txType` 是單一 byte（`0x01`, `0x02`, `0x03`, `0x04`），後面接該類型專屬欄位的 RLP 編碼。

### Nonce 管理

[[Nonce]] 是交易排序和防重放的關鍵。需要注意的是，nonce 在 Ethereum 中有兩種不同含義：

| 類型 | Nonce 含義 | 遞增時機 | 查詢方式 |
|------|-----------|---------|---------|
| EOA nonce | 該帳戶已發送的交易數量 | 每筆交易執行時 +1 | `eth_getTransactionCount` |
| 合約 nonce | 該合約已透過 CREATE 建立的子合約數量 | 每次 CREATE 時 +1 | 無直接 RPC，需查 state |

交易構建時用的是 **EOA nonce**，規則如下：

- 必須等於發送者已確認交易數量（`pending` 狀態下為包含 pending 的計數）
- nonce 不連續的交易會卡在 mempool（例如 nonce 5 還沒執行，nonce 6 就會等待）
- 同一 nonce 的新交易可以替換舊的（需要更高 gas price，通常至少 +10%）

合約 nonce 影響的是 `CREATE` opcode 產生的新合約地址（`address = keccak256(rlp([sender, nonce]))[12:]`），與交易構建無直接關係，但在分析合約部署時會遇到。

### Gas 三個層次

Gas 在交易流程的不同階段有不同含義，容易混淆。以下統一定義：

| 層次 | 名稱 | 定義 | 決定者 |
|------|------|------|--------|
| 1 | Intrinsic gas | 交易本身的固定成本：21,000（基礎）+ calldata 成本（每個零 byte 4 gas，非零 byte 16 gas）+ access list 成本 | 協議規則 |
| 2 | Execution gas | EVM 執行合約程式碼消耗的 gas（每個 opcode 有固定費用，SSTORE 最貴可達 20,000） | 合約邏輯 |
| 3 | baseFee | 每單位 gas 的最低價格，由協議根據前一區塊的使用率動態調整（[[EIP-1559 費用市場]]） | 協議算法 |

交易實際消耗的 gas = intrinsic gas + execution gas。使用者支付的費用 = 消耗的 gas * effectiveGasPrice。其中 baseFee 部分被銷毀，priority fee 部分歸 validator。

### Gas 估算

`gasLimit` 設得太低會導致 out-of-gas revert（gas 照扣）；太高則鎖住不必要的 ETH。常見策略：

1. 呼叫 `eth_estimateGas` 取得估算值
2. 加上 20-30% 的 buffer
3. 純 ETH 轉帳固定為 21,000 gas（只有 intrinsic gas，無 execution gas）

## 在 Ethereum 中的應用

- **ETH 轉帳**：`to` = 收款地址，`value` = 金額，`data` = 空
- **合約呼叫**：`to` = 合約地址，`data` = [[ABI 編碼]] 的函數選擇器 + 參數
- **合約部署**：`to` = null，`data` = init code（constructor bytecode + args）
- **EIP-4844 blob 交易**：Type 3，額外帶有 blob hash 和 blob sidecar（[[EIP-4844 Proto-Danksharding]]）

## 程式碼範例

```javascript
import { ethers } from 'ethers';

const provider = new ethers.JsonRpcProvider('http://localhost:8545');
const wallet = new ethers.Wallet(process.env.PRIVATE_KEY, provider);

// --- 1. 純 ETH 轉帳（EIP-1559） ---
const transferTx = {
  type: 2,
  to: '0xRecipient',
  value: ethers.parseEther('1.0'),
  chainId: 1n,
};

// --- 2. 合約呼叫 ---
const iface = new ethers.Interface(['function transfer(address to, uint256 amount)']);
const calldata = iface.encodeFunctionData('transfer', [
  '0xRecipient',
  ethers.parseUnits('100', 18),
]);

const contractCallTx = {
  type: 2,
  to: '0xTokenContractAddress',
  data: calldata,
  value: 0n,
};

// --- 3. 自動填充欄位 ---
// ethers.js 會自動查詢 nonce、estimateGas、feeData
const populatedTx = await wallet.populateTransaction(contractCallTx);
console.log('Nonce:', populatedTx.nonce);
console.log('Gas Limit:', populatedTx.gasLimit);
console.log('Max Fee:', ethers.formatUnits(populatedTx.maxFeePerGas, 'gwei'), 'gwei');

// --- 4. 手動組裝（完全控制） ---
const [nonce, feeData] = await Promise.all([
  provider.getTransactionCount(wallet.address, 'pending'),
  provider.getFeeData(),
]);

const manualTx = {
  type: 2,
  chainId: 1n,
  nonce: nonce,
  to: '0xRecipient',
  value: ethers.parseEther('0.5'),
  data: '0x',
  maxFeePerGas: feeData.maxFeePerGas,
  maxPriorityFeePerGas: feeData.maxPriorityFeePerGas,
  gasLimit: 21000n,
};

// --- 5. 取得序列化結果（簽名前） ---
const serializedUnsigned = ethers.Transaction.from(manualTx).unsignedSerialized;
console.log('Unsigned serialized:', serializedUnsigned);

// --- 6. 合約部署 ---
const deployTx = {
  type: 2,
  data: '0x608060405234801561001057600080fd5b50...', // contract bytecode
  // to 欄位省略 = 合約部署
};
```

## 相關概念

- [[交易生命週期]] - 本筆記是流程第二步
- [[密鑰生成與帳戶創建]] - 流程上一步
- [[交易簽名]] - 流程下一步：對構建結果簽章
- [[RLP 編碼]] - 交易序列化格式
- [[ABI 編碼]] - 合約呼叫資料編碼
- [[Nonce]] - 交易序號管理
- [[Gas]] - 計算資源計量
- [[EIP-1559 費用市場]] - Type 2 交易的費用機制
- [[EIP-155 重放保護]] - Chain ID 防跨鏈重放
- [[EIP-4844 Proto-Danksharding]] - Type 3 blob 交易
