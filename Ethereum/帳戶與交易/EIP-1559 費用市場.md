---
tags: [ethereum, eip-1559, gas, fee-market, base-fee, burn]
aliases: [EIP-1559, EIP-1559 費用市場, Fee Market, Base Fee, London Hard Fork]
---

# EIP-1559 費用市場

## 概述

EIP-1559 徹底重構了 Ethereum 的交易費用機制。取代原本的簡單 gas price 競標，引入了「base fee + priority fee」模式：base fee 由協定根據區塊使用率動態調整並燃燒，priority fee（tip）給驗證者。這讓費用更可預測、減少超額支付，並讓 ETH 具備通縮特性。於 2021 年 8 月的 London Hard Fork 啟用。

## 核心原理

### 舊模式的問題

Pre-EIP-1559 的 first-price auction：
- 使用者猜 gas price → 常常猜太高（超額支付）或猜太低（交易卡住）
- Gas price 波動劇烈，難以預測
- 全部費用給礦工，沒有燃燒機制
- 礦工可操縱 gas price（spam 自己的交易填滿區塊）

### 新模式架構

```
交易費用 = gasUsed * effectiveGasPrice

effectiveGasPrice = min(maxFeePerGas, baseFee + maxPriorityFeePerGas)

分配:
  baseFee 部分 → 燃燒（永久從流通中移除）
  剩餘部分     → 給驗證者（priority fee / tip）
```

### 三個費用參數

| 參數 | 說明 | 由誰決定 |
|------|------|----------|
| `baseFee` | 每單位 gas 的最低價格 | 協定自動計算 |
| `maxPriorityFeePerGas` | 願意給驗證者的最高小費 | 使用者設定 |
| `maxFeePerGas` | 願意支付的最高總 gas price | 使用者設定 |

實際支付的 gas price：

$$\text{effective} = \min(\text{maxFeePerGas}, \text{baseFee} + \text{maxPriorityFeePerGas})$$

退款：

$$\text{refund} = (\text{maxFeePerGas} - \text{effective}) \times \text{gasUsed}$$

### Base Fee 動態調整

每個區塊的 base fee 根據**上一個區塊的 gas 使用率**調整：

- **目標**：每個區塊的 gas 使用率 = 50%（target gas = gasLimit / 2）
- **上限**：gasLimit（以前叫 gas ceiling）
- **調整**：每個區塊最多變動 12.5%

$$\text{baseFee}_{n+1} = \text{baseFee}_n \times \left(1 + \frac{1}{8} \times \frac{\text{gasUsed}_n - \text{target}}{\text{target}}\right)$$

展開：

$$\text{baseFee}_{n+1} = \text{baseFee}_n + \text{baseFee}_n \times \frac{\text{gasUsed}_n - \text{target}}{8 \times \text{target}}$$

具體場景：

| 區塊使用率 | baseFee 變化 |
|-----------|-------------|
| 100%（滿載） | +12.5% |
| 75% | +6.25% |
| 50%（目標） | 不變 |
| 25% | -6.25% |
| 0%（空區塊） | -12.5% |

### 連續滿載的 base fee 增長

如果連續 $k$ 個區塊都 100% 滿載：

$$\text{baseFee}_k = \text{baseFee}_0 \times 1.125^k$$

| 連續滿載區塊數 | baseFee 倍數 |
|---------------|-------------|
| 10 | ~3.25x |
| 20 | ~10.5x |
| 50 | ~267x |
| 100 | ~71,000x |

指數增長確保需求高峰不會無限持續——fee 會快速上漲到壓制需求。

### Gas Limit 提升對 Base Fee 的影響

2025 年 block gas limit 從 30M 逐步提升至 60M（見 [[Gas]]），直接影響 EIP-1559 的 base fee 動態：

- **Target gas 加倍**：target = gasLimit / 2，從 15M 提升到 30M。同樣的絕對需求量在更大的區塊中佔比更低，base fee 的上行壓力減小。
- **費用降低**：在需求不變的情況下，更大的區塊意味著更低的 base fee——區塊使用率低於 50% 時 base fee 會持續下降。
- **對燃燒量的影響**：base fee 降低會減少 ETH 燃燒速率，可能使 ETH 在低需求期更趨通膨。

### Blob Fee Market 與 EIP-1559

EIP-4844（Dencun，2024/3）引入了獨立於 execution gas 的 blob fee market，其運作邏輯類似 EIP-1559 但參數不同：

- Blob 有自己的 base fee，根據 blob 使用率獨立調整
- 目標為每區塊 3 個 blob（最大 6 個）
- Blob base fee 的調整速度比 execution base fee 更快

兩套 fee market 平行運作：交易的 execution 部分按 EIP-1559 計費，blob 部分按 blob fee market 計費。這讓 L2 的 data availability 成本與 L1 的 execution 需求脫鉤。

### ETH 燃燒機制

每個區塊燃燒的 ETH：

$$\text{burn} = \sum_{i} \text{gasUsed}_i \times \text{baseFee}$$

這讓 ETH 有了「通縮壓力」：
- 如果燃燒量 > 新發行量 → ETH 通縮（ultrasound money）
- Merge 後每個 slot ~0.002 ETH 發行
- 高 gas 時代（baseFee > ~20 gwei），燃燒量常超過發行量

### 交易類型

EIP-1559 引入 Type 2 transaction：

```
Type 2 Transaction:
0x02 || RLP([
  chainId,
  nonce,
  maxPriorityFeePerGas,  // 新欄位
  maxFeePerGas,          // 新欄位（取代 gasPrice）
  gasLimit,
  to,
  value,
  data,
  accessList,
  signatureYParity,
  signatureR,
  signatureS
])
```

Legacy（Type 0）交易仍然相容：`gasPrice` 同時作為 `maxFeePerGas` 和 `maxPriorityFeePerGas`。

## 在 Ethereum 中的應用

- **[[Gas]]**：EIP-1559 重新定義了 gas 費用結構
- **[[區塊 Header]]**：新增 `baseFeePerGas` 欄位
- **[[區塊生產]]**：驗證者根據 priority fee 排序交易
- **[[交易構建]]**：使用者設定 maxFeePerGas 和 maxPriorityFeePerGas
- **[[Transaction Trie]]**：Type 2 交易的序列化格式
- **[[記憶池]]**：mempool 中 priority fee 較高的交易優先
- **[[EIP-155 重放保護]]**：Type 2 交易直接包含 chainId
- **MEV**：Searcher 透過 priority fee 競標交易位置
- **ETH 貨幣政策**：base fee 燃燒影響 ETH 供給量

### 費用設定策略

| 情境 | maxPriorityFeePerGas | maxFeePerGas |
|------|---------------------|-------------|
| 不急 | 1-2 gwei | baseFee + tip |
| 正常 | 2-3 gwei | baseFee * 2 + tip |
| 緊急 | 5-10+ gwei | baseFee * 3 + tip |

`maxFeePerGas` 設比 baseFee 高可以容忍幾個區塊的 baseFee 上漲，不會因 baseFee 漲了就交易失敗。

## 程式碼範例

### JavaScript（ethers.js）

```javascript
import { JsonRpcProvider, Wallet, parseEther, formatUnits, parseUnits } from 'ethers';

const provider = new JsonRpcProvider('https://eth.llamarpc.com');

// 查詢當前費用
const [feeData, block] = await Promise.all([
  provider.getFeeData(),
  provider.getBlock('latest'),
]);

const baseFee = block.baseFeePerGas;
console.log('baseFee:', formatUnits(baseFee, 'gwei'), 'gwei');
console.log('suggested maxFeePerGas:', formatUnits(feeData.maxFeePerGas, 'gwei'), 'gwei');
console.log('suggested maxPriorityFeePerGas:', formatUnits(feeData.maxPriorityFeePerGas, 'gwei'), 'gwei');

// 計算下一個區塊的 baseFee
function predictNextBaseFee(parentBaseFee, parentGasUsed, parentGasLimit) {
  const target = parentGasLimit / 2n;

  if (parentGasUsed === target) {
    return parentBaseFee;
  }

  if (parentGasUsed > target) {
    const delta = parentBaseFee * (parentGasUsed - target) / target / 8n;
    return parentBaseFee + (delta > 0n ? delta : 1n);
  }

  const delta = parentBaseFee * (target - parentGasUsed) / target / 8n;
  return parentBaseFee - delta;
}

const nextBaseFee = predictNextBaseFee(
  baseFee,
  block.gasUsed,
  block.gasLimit,
);
console.log('predicted next baseFee:', formatUnits(nextBaseFee, 'gwei'), 'gwei');

// 計算區塊 ETH 燃燒量
const burned = block.gasUsed * baseFee;
console.log('ETH burned in block:', formatUnits(burned, 'ether'), 'ETH');

// 查詢歷史 baseFee 趨勢
const latest = block.number;
for (let i = 0; i < 5; i++) {
  const b = await provider.getBlock(latest - i);
  const utilization = Number(b.gasUsed) / Number(b.gasLimit) * 100;
  console.log(
    `block ${b.number}: baseFee=${formatUnits(b.baseFeePerGas, 'gwei')} gwei, ` +
    `utilization=${utilization.toFixed(1)}%`
  );
}

// 發送 EIP-1559 交易
const wallet = new Wallet('0x...', provider);
const tx = await wallet.sendTransaction({
  type: 2,
  to: '0x...',
  value: parseEther('0.01'),
  maxFeePerGas: baseFee * 2n + parseUnits('2', 'gwei'),
  maxPriorityFeePerGas: parseUnits('2', 'gwei'),
  gasLimit: 21000n,
});

const receipt = await tx.wait();
const effectiveGasPrice = receipt.gasPrice; // ethers v6 returns effectiveGasPrice here
console.log('effective gas price:', formatUnits(effectiveGasPrice, 'gwei'), 'gwei');
console.log('actual fee:', formatUnits(receipt.gasUsed * effectiveGasPrice, 'ether'), 'ETH');
```

### Python（web3.py）

```python
from web3 import Web3

w3 = Web3(Web3.HTTPProvider('https://eth.llamarpc.com'))

block = w3.eth.get_block('latest')
base_fee = block['baseFeePerGas']
print(f"baseFee: {w3.from_wei(base_fee, 'gwei')} gwei")
print(f"gasUsed: {block['gasUsed']}")
print(f"gasLimit: {block['gasLimit']}")

utilization = block['gasUsed'] / block['gasLimit']
print(f"utilization: {utilization * 100:.1f}%")

# 預測下一個 baseFee
def predict_next_base_fee(parent_base_fee, parent_gas_used, parent_gas_limit):
    target = parent_gas_limit // 2

    if parent_gas_used == target:
        return parent_base_fee
    elif parent_gas_used > target:
        delta = max(
            parent_base_fee * (parent_gas_used - target) // target // 8,
            1
        )
        return parent_base_fee + delta
    else:
        delta = parent_base_fee * (target - parent_gas_used) // target // 8
        return parent_base_fee - delta

next_fee = predict_next_base_fee(
    base_fee, block['gasUsed'], block['gasLimit']
)
print(f"predicted next baseFee: {w3.from_wei(next_fee, 'gwei')} gwei")

# ETH 燃燒量
burned = block['gasUsed'] * base_fee
print(f"burned: {w3.from_wei(burned, 'ether')} ETH")

# 歷史趨勢
latest = block['number']
for i in range(5):
    b = w3.eth.get_block(latest - i)
    bf = w3.from_wei(b['baseFeePerGas'], 'gwei')
    util = b['gasUsed'] / b['gasLimit'] * 100
    print(f"block {b['number']}: baseFee={bf:.2f} gwei, util={util:.1f}%")

# EIP-1559 交易建構
tx = {
    'type': 2,  # EIP-1559
    'chainId': 1,
    'nonce': 0,
    'maxFeePerGas': base_fee * 2 + w3.to_wei(2, 'gwei'),
    'maxPriorityFeePerGas': w3.to_wei(2, 'gwei'),
    'gas': 21000,
    'to': '0x0000000000000000000000000000000000000001',
    'value': 0,
}
print(f"maxFeePerGas: {w3.from_wei(tx['maxFeePerGas'], 'gwei')} gwei")
```

## 相關概念

- [[Gas]] - EIP-1559 重新定義的計費單位
- [[區塊 Header]] - 包含 `baseFeePerGas` 欄位
- [[區塊生產]] - 驗證者根據 tip 選擇交易
- [[交易構建]] - EIP-1559 交易的費用參數
- [[Transaction Trie]] - Type 2 交易的序列化
- [[EIP-155 重放保護]] - Type 2 交易包含 chainId
- [[記憶池]] - 交易按 priority fee 排序
- [[Nonce]] - 交易替換需要更高的 maxFeePerGas
- [[交易生命週期]] - 費用影響交易的處理速度
